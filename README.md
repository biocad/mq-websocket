# mq-websocket

Данный модуль предоставляет возможность различным приложениям и сервисам общаться с компонентами системы MoniQue посредством websocket.
Такие приложения и сервисы в данном документе будут называться **клиентами**.

Данный модуль является компонентом MoniQue, который реализует следующую логику:
  1. принимает сообщение из websocket-каналов и отправляет их в ["одно место" (Scheduler)](https://github.com/biocad/mq/blob/master/doc/Scheduler.md);
  2. принимает сообщение из "одного места" и отправляет его в те websocket-каналы, которые в нём были заинтересованы.

Прежде всего, опишем правила, по которым клиент общается с данным компонентом.
  
## Протокол общения

Протокол общения построен поверх протокола MoniQue, который описан [тут](https://github.com/biocad/mq/blob/master/doc/Protocol.md).
Дополнением к этому служат служебные сообщения, которые предназначены для корректной работы websocket-каналов.
Каждый тип сообщений может отправляться либо от клиента серверу, либо наоборот.

Любое сообщение между клиентом и сервером упаковывается в MessagePack и имеет следующий вид:
```
{ command :: str,
  data    :: str | bin
}
```

Поле `command` определяет "тип" передаваемого сообщения, имеет строковый тип.
Поле `data` несёт смысловую нагрузку, имеет строковый или бинарный тип.

Далее расписаны все типы сообщений.
Заголовок при этом соответствует передаваемой команде, а в скобках указывается, кому и от кого передаётся сообщение.
Для каждого типа сообщения указывается пример в формате hex-массива.
Посмотреть на декодированную версию сообщения можно по [этой](https://kawanet.github.io/msgpack-lite/) ссылке, скопировав пример в нужное поле.

### ping (от клиента серверу)

Предназначен для проверки соединения.

Поле `data` заполняется Unix-временем в наносекундах.

Пример:
```
82 a7 63 6f 6d 6d 61 6e 64 a4 70 69 6e 67 a4 64 61 74 61 cf 15 35 7 50 87 9e 40 3b
```

### pong (от сервера клиенту) 

Отправляется в ответ на сообщение ping.
Поле `data` содержит время, переданное при запросе `ping`.

Пример:
```
82 a7 63 6f 6d 6d 61 6e 64 a4 70 6f 6e 67 a4 64 61 74 61 cf 15 35 7 50 87 9e 40 3b
```

### subscribe (от клиента серверу)

По-умолчанию **никакое** сообщение, которое было получено из MoniQue, не будет отправлено в websocket-коннекцию.
Для того, чтобы получать такие сообщения, коннекция должна оформить подписку на те сообщения, которые она желает принимать.

Подписка определяется спецификацией и типом сообщения (для подробностей читай протокол MoniQue) и имеет вид:

```
{ spec :: str
, type :: str
}
```

Вместо значений `spec` и/или `type` может быть передан символ `*` (звездочка), который обозначает то, что текущая коннекция желает подписаться на все спецификации и/или типы сообщений.

Поле `data` сообщения о подписке может содержать сразу несколько подписок и имеет вид
```
[ 
  { spec :: str
  , type :: str
  }
]
```

Пример:
```
82 a7 63 6f 6d 6d 61 6e 64 a9 73 75 62 73 63 72 69 62 65 a4 64 61 74 61 91 82 a4 73 70 65 63 a1 2a a4 74 79 70 65 a1 2a
```

### subscribed (от сервера клиенту)

Является подтверждением на запрос клиента о подписке.
Поле `data` имеет тот же формат и содержание, что и сообщение `subscribe`.

Пример:
```
82 a7 63 6f 6d 6d 61 6e 64 aa 73 75 62 73 63 72 69 62 65 64 a4 64 61 74 61 91 82 a4 73 70 65 63 a1 2a a4 74 79 70 65 a1 2a
```

### unsubscribe (от клиента серверу)

Если текущая коннекция более не заинтересована в сообщениях определённой спецификации и типа, она может отозвать подписку.
Поле `data` имеет тот же формат, что и сообщение `subscribe`.

Пример:
```
82 a7 63 6f 6d 6d 61 6e 64 ab 75 6e 73 75 62 73 63 72 69 62 65 a4 64 61 74 61 91 82 a4 73 70 65 63 a1 2a a4 74 79 70 65 a1 2a
```

### unsubscribed (от сервера клиенту)

Является подтверждением отзыва подписки.
Поле `data` имеет тот же формат, что и сообщение `subscribe`.

Пример:
```
82 a7 63 6f 6d 6d 61 6e 64 ac 75 6e 73 75 62 73 63 72 69 62 65 64 a4 64 61 74 61 91 82 a4 73 70 65 63 a1 2a a4 74 79 70 65 a1 2a
```

### push_to_mq (от клиента серверу)

Является запросом от клиента на передачу сообщения в MoniQue.

Напомним, что, согласно протоколу MoniQue, для любого сообщения (`message`) можно сформировать тэг (`tag`).
Форматом для передаваемых сообщений является MessagePack.
Сообщения должны быть упакованы в словарь MessagePack со следующими полями:

```
{ 
  tag     :: str,
  message :: bin
}
```

где поля:
  * `tag` - сформированный про [правилам](https://github.com/biocad/mq/blob/master/doc/Protocol.md#%D0%97%D0%B0%D0%B3%D0%BE%D0%BB%D0%BE%D0%B2%D0%BE%D0%BA-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F) тэг сообщения;
  * `message` - тело самого сообщения, которое будет отправлено вместе с тэгом в "одно место".
  
Надо обратить внимание на то, что поле `message` должно содержать сообщение в таком виде, что его можно без дополнительного преобразования отправить в "одно место". Это значит, что сообщение к этому моменту должно быть сконвертировано в MessagePack.
А в случае необходимости и возможности шифрования, то и зашифровано.

Для большей ясности разберём пример.

Пусть клиент хочет отправить по websocket следующее сообщение: 
```
{ id = "CunulYa0vipgCQ3KSTmXwt67Qn0="
, pid = ""
, creator = "0000-0000-0000-websocket-tester"
, created_at = 1528138732079
, expires_at = 0
, spec = "example_calculator"
, encoding = "JSON"
, type = config
, data = "{\"first\":6,\"second\":5.0,\"action\":\"/\"}"
}
```

Тогда тэг для данного сообщения будет иметь вид
```
config:example_calculator:CunulYa0vipgCQ3KSTmXwt67Qn0=::0000-0000-0000-websocket-tester
```

Если закодировать сообщение в MessagePack, оно будет иметь вид
```
"\137\170created_at\207\NUL\NUL\SOHc\204*\146/\167creator\191\&0000-0000-0000-websocket-tester\164data\196&{\"first\":6,\"second\":5.0,\"action\":\"/\"}\n\168encoding\164JSON\170expires_at\NUL\162id\196\FSCunulYa0vipgCQ3KSTmXwt67Qn0=\163pid\196\NUL\164spec\178example_calculator\164type\166config"
```
или в HEX-формате
```
9 aa 63 72 65 61 74 65 64 5f 61 74 cf 0 0 1 63 cc 2a 92 2f a7 63 72 65 61 74 6f 72 bf 30 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 77 65 62 73 6f 63 6b 65 74 2d 74 65 73 74 65 72 a4 64 61 74 61 c4 26 7b 22 66 69 72 73 74 22 3a 36 2c 22 73 65 63 6f 6e 64 22 3a 35 2e 30 2c 22 61 63 74 69 6f 6e 22 3a 22 2f 22 7d a a8 65 6e 63 6f 64 69 6e 67 a4 4a 53 4f 4e aa 65 78 70 69 72 65 73 5f 61 74 0 a2 69 64 c4 1c 43 75 6e 75 6c 59 61 30 76 69 70 67 43 51 33 4b 53 54 6d 58 77 74 36 37 51 6e 30 3d a3 70 69 64 c4 0 a4 73 70 65 63 b2 65 78 61 6d 70 6c 65 5f 63 61 6c 63 75 6c 61 74 6f 72 a4 74 79 70 65 a6 63 6f 6e 66 69 67
```

Полностью же сообщение, которое будет готово для отправки в websocket, будет иметь вид
```
82 a7 63 6f 6d 6d 61 6e 64 aa 70 75 73 68 5f 74 6f 5f 6d 71 a4 64 61 74 61 82 a7 6d 65 73 73 61 67 65 c4 cf 89 aa 63 72 65 61 74 65 64 5f 61 74 cf 0 0 1 63 cc 2a 92 2f a7 63 72 65 61 74 6f 72 bf 30 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 77 65 62 73 6f 63 6b 65 74 2d 74 65 73 74 65 72 a4 64 61 74 61 c4 26 7b 22 66 69 72 73 74 22 3a 36 2c 22 73 65 63 6f 6e 64 22 3a 35 2e 30 2c 22 61 63 74 69 6f 6e 22 3a 22 2f 22 7d a a8 65 6e 63 6f 64 69 6e 67 a4 4a 53 4f 4e aa 65 78 70 69 72 65 73 5f 61 74 0 a2 69 64 c4 1c 43 75 6e 75 6c 59 61 30 76 69 70 67 43 51 33 4b 53 54 6d 58 77 74 36 37 51 6e 30 3d a3 70 69 64 c4 0 a4 73 70 65 63 b2 65 78 61 6d 70 6c 65 5f 63 61 6c 63 75 6c 61 74 6f 72 a4 74 79 70 65 a6 63 6f 6e 66 69 67 a3 74 61 67 c4 57 63 6f 6e 66 69 67 3a 65 78 61 6d 70 6c 65 5f 63 61 6c 63 75 6c 61 74 6f 72 3a 43 75 6e 75 6c 59 61 30 76 69 70 67 43 51 33 4b 53 54 6d 58 77 74 36 37 51 6e 30 3d 3a 3a 30 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 77 65 62 73 6f 63 6b 65 74 2d 74 65 73 74 65 72
```

### pushed_to_mq (от сервера клиенту)

Является подтверждением того, что websocket-сервер принял сообщение.

Поле `data` содержит в бинарном виде `tag` сообщения, которое было получено при команде "push_to_mq".

Пример:
```
82 a7 63 6f 6d 6d 61 6e 64 ac 70 75 73 68 65 64 5f 74 6f 5f 6d 71 a4 64 61 74 61 c4 57 63 6f 6e 66 69 67 3a 65 78 61 6d 70 6c 65 5f 63 61 6c 63 75 6c 61 74 6f 72 3a 43 75 6e 75 6c 59 61 30 76 69 70 67 43 51 33 4b 53 54 6d 58 77 74 36 37 51 6e 30 3d 3a 3a 30 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 77 65 62 73 6f 63 6b 65 74 2d 74 65 73 74 65 72
```

### pushed_from_mq (от сервера клиента)

Используется для того, чтобы передать клиенту сообщение из MoniQue.
Поле `data` имеет тот же формат, что и сообщение `push_to_mq`.

То есть для MoniQue-сообщения с тэгом
```
result:example_calculator:aoH9WCyq+2sFRg40WxRWByfVcBE=:VJuujbbNlNQ0d/xqCvv2E11Orw0=:0000-0000-0000-calculator
```
и MessagePack представлением
```
89 aa 63 72 65 61 74 65 64 5f 61 74 cf 0 0 1 63 cc 37 58 93 a7 63 72 65 61 74 6f 72 b9 30 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 63 61 6c 63 75 6c 61 74 6f 72 a4 64 61 74 61 c4 e 7b 22 61 6e 73 77 65 72 22 3a 31 2e 32 7d a8 65 6e 63 6f 64 69 6e 67 a4 4a 53 4f 4e aa 65 78 70 69 72 65 73 5f 61 74 0 a2 69 64 c4 1c 61 6f 48 39 57 43 79 71 2b 32 73 46 52 67 34 30 57 78 52 57 42 79 66 56 63 42 45 3d a3 70 69 64 c4 1c 56 4a 75 75 6a 62 62 4e 6c 4e 51 30 64 2f 78 71 43 76 76 32 45 31 31 4f 72 77 30 3d a4 73 70 65 63 b2 65 78 61 6d 70 6c 65 5f 63 61 6c 63 75 6c 61 74 6f 72 a4 74 79 70 65 a6 72 65 73 75 6c 74
```
сообщение, которое будет отправлено по websocket, будет иметь вид
```
82 a7 63 6f 6d 6d 61 6e 64 ae 70 75 73 68 65 64 5f 66 72 6f 6d 5f 6d 71 a4 64 61 74 61 82 a7 6d 65 73 73 61 67 65 c4 cd 89 aa 63 72 65 61 74 65 64 5f 61 74 cf 0 0 1 63 cc 37 58 93 a7 63 72 65 61 74 6f 72 b9 30 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 63 61 6c 63 75 6c 61 74 6f 72 a4 64 61 74 61 c4 e 7b 22 61 6e 73 77 65 72 22 3a 31 2e 32 7d a8 65 6e 63 6f 64 69 6e 67 a4 4a 53 4f 4e aa 65 78 70 69 72 65 73 5f 61 74 0 a2 69 64 c4 1c 61 6f 48 39 57 43 79 71 2b 32 73 46 52 67 34 30 57 78 52 57 42 79 66 56 63 42 45 3d a3 70 69 64 c4 1c 56 4a 75 75 6a 62 62 4e 6c 4e 51 30 64 2f 78 71 43 76 76 32 45 31 31 4f 72 77 30 3d a4 73 70 65 63 b2 65 78 61 6d 70 6c 65 5f 63 61 6c 63 75 6c 61 74 6f 72 a4 74 79 70 65 a6 72 65 73 75 6c 74 a3 74 61 67 c4 6f c4 6d 72 65 73 75 6c 74 3a 65 78 61 6d 70 6c 65 5f 63 61 6c 63 75 6c 61 74 6f 72 3a 61 6f 48 39 57 43 79 71 2b 32 73 46 52 67 34 30 57 78 52 57 42 79 66 56 63 42 45 3d 3a 56 4a 75 75 6a 62 62 4e 6c 4e 51 30 64 2f 78 71 43 76 76 32 45 31 31 4f 72 77 30 3d 3a 30 30 30 30 2d 30 30 30 30 2d 30 30 30 30 2d 63 61 6c 63 75 6c 61 74 6f 72
```

## config.json

Помимо [стандартных полей](https://github.com/biocad/mq/blob/master/doc/ConfigJson.md) MoniQue-компонента в разделе "deploy -> monique -> websocket" указываются следующие поля:
  * `host` - хост, который будет слушать компонент для канала websocket;
  * `port` - порт, который будет слушать компонент для канала websocket.
  
## Сборка и запуск

Сборка данной библиотеки осуществляется из внутренней сети компании BIOCAD (до того момента, как данный компонент будет переведён в hackage) с помощью инструмента [stack](https://www.haskellstack.org/):

```
stack build
```

Запуск компонента осуществляется командой

```
stack exec mq-websocket
```

Для тестирования данного модуля можно запустить тестовое приложение (предварительно перед этим подняв пример с [калькулятором](https://github.com/biocad/mq-component-hs#%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%BA%D0%B0%D0%BB%D1%8C%D0%BA%D1%83%D0%BB%D1%8F%D1%82%D0%BE%D1%80)):

```
stack exec tester
```

Для подсказки по доступным командам можно вбить `help`.
А для отправки по websocket сообщение с примером калькулятора можно ввести
```
push example_calculator config JSON test/calculator.json
```
